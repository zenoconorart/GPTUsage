<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GPT Usage Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
  <style>
    :root { color-scheme: dark; }
    body { margin: 0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#0b0f14; color:#e6edf3; }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 32px; }
    h1 { font-size: 28px; margin: 0 0 8px; }
    .muted { color:#9aa4b2; }
    .cards { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap:16px; margin:24px 0; }
    .card { background:#111824; border:1px solid #1f2a3a; border-radius:12px; padding:16px; }
    .card h3 { margin:0 0 8px; font-size:14px; color:#9aa4b2; font-weight:600; text-transform:uppercase; letter-spacing:.06em; }
    .card .value { font-size:24px; font-weight:700; }
    .row { display:flex; gap:16px; flex-wrap:wrap; align-items:center; }
    .input { background:#0f1520; border:1px solid #1f2a3a; color:#e6edf3; padding:10px 12px; border-radius:8px; }
    button { background:#2d6cdf; color:white; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:600; }
    button:hover { background:#2457b8; }
    canvas { background:#0f1520; border:1px solid #1f2a3a; border-radius:12px; padding:8px; }
    .footer { margin-top: 16px; font-size:12px; color:#7f8a99; }
    a { color:#7fb2ff; text-decoration:none; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>GPT Usage Dashboard</h1>
    <div class="muted">Live usage pulled from OpenAI billing API</div>

    <div class="row" style="margin-top:16px;">
      <button id="refresh">Refresh</button>
      <span id="status" class="muted"></span>
    </div>

    <div class="row" style="margin-top:12px;">
      <span class="muted">Showing last 5 days</span>
      <input id="daySlider" type="range" min="0" max="0" value="0" class="input" style="flex:1;" />
      <span id="rangeLabel" class="muted"></span>
    </div>

    <div class="cards">
      <div class="card"><h3>Total Spend</h3><div class="value" id="totalSpend">—</div></div>
      <div class="card"><h3>Total Requests</h3><div class="value" id="totalRequests">—</div></div>
      <div class="card"><h3>Total Tokens</h3><div class="value" id="totalTokens">—</div></div>
      <div class="card"><h3>Last Updated</h3><div class="value" id="lastUpdated">—</div></div>
    </div>

    <div class="card">
      <h3>Daily Spend</h3>
      <canvas id="chart" height="120"></canvas>
    </div>

    <div class="footer">Data source: OpenAI billing usage endpoint. Repo: <a href="https://github.com/zenoconorart/GPTUsage">zenoconorart/GPTUsage</a></div>
  </div>

<script>
  const API_BASE = 'https://gptusage.onrender.com';

  const statusEl = document.getElementById('status');
  const totalSpendEl = document.getElementById('totalSpend');
  const totalRequestsEl = document.getElementById('totalRequests');
  const totalTokensEl = document.getElementById('totalTokens');
  const lastUpdatedEl = document.getElementById('lastUpdated');
  const daySlider = document.getElementById('daySlider');
  const rangeLabel = document.getElementById('rangeLabel');

  let chart;
  let fullLabels = [];
  let fullValues = [];

  async function fetchUsage(startDate, endDate) {
    const url = `${API_BASE}/usage?start_date=${startDate}&end_date=${endDate}`;
    const res = await fetch(url);
    if (!res.ok) {
      const text = await res.text();
      throw new Error(text || res.statusText);
    }
    return res.json();
  }

  async function fetchUsdToGbp() {
    const res = await fetch('https://open.er-api.com/v6/latest/USD');
    if (!res.ok) throw new Error('Failed to load FX rate');
    const data = await res.json();
    const rate = data?.rates?.GBP;
    if (!rate) throw new Error('GBP rate missing');
    return rate;
  }

  function renderChart(labels, values) {
    const ctx = document.getElementById('chart');
    if (chart) chart.destroy();
    chart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'GBP',
          data: values,
          backgroundColor: 'rgba(45,108,223,0.6)',
          borderColor: '#2d6cdf',
          borderWidth: 1,
          barPercentage: 0.9,
          categoryPercentage: 0.9
        }]
      },
      options: {
        plugins: {
          legend: { display: false },
          datalabels: {
            color: '#e6edf3',
            anchor: 'end',
            align: 'end',
            formatter: (v) => (Number(v || 0) >= 0.01 ? `£${Number(v || 0).toFixed(2)}` : ''),
            clamp: true,
            font: { size: 10 }
          }
        },
        scales: {
          x: { ticks: { color: '#9aa4b2', maxRotation: 0, autoSkip: false }, grid: { color: '#1f2a3a' } },
          y: { ticks: { color: '#9aa4b2' }, grid: { color: '#1f2a3a' }, beginAtZero: true }
        }
      },
      plugins: [ChartDataLabels]
    });
  }

  async function refresh() {
    try {
      statusEl.textContent = 'Loading…';
      const end = new Date();
      const start = new Date();
      start.setDate(start.getDate() - 30);
      const s = start.toISOString().slice(0,10);
      const e = end.toISOString().slice(0,10);
      const data = await fetchUsage(s, e);
      const fx = await fetchUsdToGbp();

      const daily = data.daily_costs || [];
      const labels = daily.map(d => d.timestamp ? new Date(d.timestamp*1000).toISOString().slice(0,10) : '');
      const valuesUsd = daily.map(d => Number(d.total_cost || 0));
      const valuesGbp = valuesUsd.map(v => v * fx);

      const totalSpendGbp = valuesGbp.reduce((a,b)=>a + Number(b || 0), 0);
      const totalRequests = daily.reduce((a,b)=>a+(b.num_requests||0),0);
      const totalTokens = daily.reduce((a,b)=>a+(b.num_tokens||0),0);

      totalSpendEl.textContent = `£${totalSpendGbp.toFixed(2)}`;
      totalRequestsEl.textContent = totalRequests.toLocaleString();
      totalTokensEl.textContent = totalTokens.toLocaleString();
      lastUpdatedEl.textContent = new Date().toLocaleString();

      fullLabels = labels;
      fullValues = valuesGbp;
      const windowSize = 5;
      const maxStart = Math.max(0, fullLabels.length - windowSize);
      daySlider.max = String(maxStart);
      daySlider.value = String(maxStart);

      updateWindow();
      statusEl.textContent = `Updated (FX ${fx.toFixed(4)} GBP/USD)`;
    } catch (err) {
      console.error(err);
      statusEl.textContent = 'Error (see console)';
      totalSpendEl.textContent = '—';
      totalRequestsEl.textContent = '—';
      totalTokensEl.textContent = '—';
    }
  }

  function updateWindow() {
    const windowSize = 5;
    const start = Math.min(Number(daySlider.value || 0), Math.max(0, fullLabels.length - windowSize));
    const end = Math.min(start + windowSize, fullLabels.length);
    const labels = fullLabels.slice(start, end);
    const values = fullValues.slice(start, end);
    renderChart(labels, values);
    rangeLabel.textContent = labels.length ? `${labels[0]} → ${labels[labels.length - 1]}` : '';
  }

  daySlider.addEventListener('input', updateWindow);
  document.getElementById('refresh').addEventListener('click', refresh);
  refresh();
</script>
</body>
</html>
